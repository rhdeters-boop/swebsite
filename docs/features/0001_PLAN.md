# Username Change Restrictions and URL Redirection

## Description
Implement username change restrictions so users can only change their username once a month. When a username is successfully changed, automatically redirect the user to their new profile URL since the user profile URL is based on the username (`/user/:username`).

## Technical Requirements

### Database Schema Changes
- **File**: `backend/models/User.js`
  - Add `lastUsernameChangeAt` field as `DataTypes.DATE`, nullable, to track when username was last changed
  - Add database index on `lastUsernameChangeAt` for query performance

### Backend API Changes

#### AuthService Update
- **File**: `backend/services/AuthService.js`
  - Modify `updateProfile()` method (lines 223-258) to:
    1. Check if username is being changed (compare with current username)
    2. If username change requested, validate that `lastUsernameChangeAt` is null or >= 30 days ago
    3. Update `lastUsernameChangeAt` to current timestamp when username is changed
    4. Return flag indicating if username was changed in response

#### Auth Route Update  
- **File**: `backend/routes/auth.js`
  - Modify `/profile` PUT endpoint (lines 200-247) to:
    1. Handle new validation error for username change frequency
    2. Return additional response field `usernameChanged: boolean` 
    3. Include new username in response when changed

### Frontend Changes

#### Profile Update Logic
- **File**: `src/pages/account/UserProfile.tsx`
  - Modify `handleProfileSubmit()` method (lines 116-148) to:
    1. Check response for `usernameChanged` flag
    2. If username changed, use React Router's `navigate()` to redirect to `/user/${newUsername}`
    3. Use `replace: true` to replace current history entry

#### Username Change Validation
- **File**: `src/components/profile/EditProfileModal.tsx`
  - Add frontend validation to check if username has changed
  - Display warning message about once-per-month restriction
  - Add confirmation dialog before submitting username changes

### Database Migration
- **File**: `backend/scripts/addUsernameChangeTracking.js` (new)
  - Create migration script following pattern from `createMediaAnalyticsTable.js`
  - Add `lastUsernameChangeAt` column to existing User table
  - Use `sequelize.sync({ alter: true })` for safe schema update

### Error Handling
- Add new error message: "Username can only be changed once per month"
- Handle frontend redirect errors gracefully
- Validate username change frequency on both frontend and backend

### Algorithm: Username Change Validation
1. User submits profile form with new username
2. Backend checks if `currentUser.username !== requestData.username`
3. If username changed:
   - Query `lastUsernameChangeAt` from database
   - Calculate days since last change: `(Date.now() - lastUsernameChangeAt) / (1000 * 60 * 60 * 24)`
   - If < 30 days, reject with error "Username can only be changed once per month"
   - If >= 30 days or null, proceed with update
   - Set `lastUsernameChangeAt = new Date()`
4. Return response with `usernameChanged: true` and new user data
5. Frontend receives response, checks `usernameChanged` flag
6. If true, redirect to `/user/${response.user.username}` with `replace: true`

### Files Modified
- `backend/models/User.js` - Add `lastUsernameChangeAt` field
- `backend/services/AuthService.js` - Add validation logic and timestamp update
- `backend/routes/auth.js` - Update response format
- `src/pages/account/UserProfile.tsx` - Add redirect logic
- `src/components/profile/EditProfileModal.tsx` - Add frontend validation
- `backend/scripts/addUsernameChangeTracking.js` - New migration script
